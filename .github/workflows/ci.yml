name: CI
on: push

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. TEST  â€“ run unit/E2E tests with Cypress
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    runs-on: ubuntu-latest
    env:
      SECRETS_BLOB: ${{ secrets.SECRETS_BLOB }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.16"              # pin to a known-good build

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps (with retry, lower concurrency)
        run: |
          for try in 1 2 3; do
            echo "ðŸ”„ bun install (try $try)â€¦"
            bun install --network-concurrency=12 --no-progress && break
            [ "$try" -lt 3 ] && { echo "âš ï¸  retrying in 15 sâ€¦"; sleep 15; }
          done

      - name: Load secrets into runner-wide env
        run: |
          echo "$SECRETS_BLOB" | base64 --decode | tr -d '\r' >> "$GITHUB_ENV"

      - uses: cypress-io/github-action@v6
        with:
          build: bun run build:no-tests
          start: bun run start
          wait-on: http://localhost:3000
          wait-on-timeout: 60
          record: true                        # set to false if you donâ€™t need the dashboard

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. DEPLOY â€“ only runs if TEST succeeds
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    needs: test
    if: success()
    runs-on: ubuntu-latest
    env:
      SECRETS_BLOB: ${{ secrets.SECRETS_BLOB }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.16"

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps (same script as test)
        run: |
          for try in 1 2 3; do
            bun install --network-concurrency=12 --no-progress && break
            [ "$try" -lt 3 ] && { echo "âš ï¸  retrying in 15 sâ€¦"; sleep 15; }
          done

      - name: Load secrets into runner-wide env
        run: |
          echo "$SECRETS_BLOB" | base64 --decode | tr -d '\r' >> "$GITHUB_ENV"

      - name: Deploy with Vercel
        run: |
          npm install -g vercel
          vercel --prod --confirm
